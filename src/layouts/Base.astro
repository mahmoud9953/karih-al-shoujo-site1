---
const { title = "موقع الروايات", description = "" } = Astro.props;
---

<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />

    <!-- Expose Supabase creds to the browser via meta tags -->
    <meta name="x-sb-url" content={import.meta.env.PUBLIC_SUPABASE_URL || ""} />
    <meta name="x-sb-key" content={import.meta.env.PUBLIC_SUPABASE_ANON_KEY || ""} />

    <!-- One-time, global Supabase client (singleton) -->
    <script type="module" src="/sb-client.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700;900&family=Tajawal:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root{
        --ink:#e7e9ee; --muted:#b3b9c7; --stroke:rgba(255,255,255,.08);
        --glass:rgba(255,255,255,.04); --bg:#0b0f14; --accent:#5b6cff;
      }
      html,body{height:100%}
      body{margin:0;color:var(--ink);font-family:Tajawal,system-ui,sans-serif;line-height:1.65;background:radial-gradient(1200px 600px at 75% -10%,rgba(110,168,255,.07),transparent 60%),radial-gradient(1000px 500px at 10% 110%,rgba(190,120,255,.06),transparent 55%),var(--bg)}
      .container{width:min(1100px,92vw);margin-inline:auto;padding:0 1rem}
      header.nav{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);background:#05070a8c;border-bottom:1px solid var(--stroke)}
      .nav-inner{display:flex;align-items:center;justify-content:space-between;height:56px;gap:12px;flex-wrap:wrap}
      .links{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
      .links a{color:var(--ink);text-decoration:none;font-weight:600}
      .card{background:var(--glass);border:1px solid var(--stroke);border-radius:16px}
      .muted{color:var(--muted)}
      #authArea{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
      #authAvatar{display:none;width:28px;height:28px;border-radius:50%;border:1px solid var(--stroke);object-fit:cover}
      .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);background:transparent;color:var(--ink);cursor:pointer;font-size:.95rem}
      @media (max-width: 600px){
        .container{width:94%;padding:0 .75rem}
        .nav-inner{flex-direction:column;align-items:flex-start;height:auto;padding:8px 0}
        .links{flex-direction:column;align-items:flex-start;gap:8px}
        #authArea{width:100%;justify-content:space-between}
        .btn{padding:8px 12px}
      }
    </style>
  </head>

  <body>
    <header class="nav">
      <div class="container nav-inner">
        <div class="links">
          <a href="/" style="text-decoration:none;color:inherit;font-weight:800">موقع الروايات</a>
          <a href="/">الرئيسية</a>
          <a href="/novels/karih-al-shoujo">كل الفصول</a>
          <a id="adminLink" href="/admin" style="display:none">لوحة الإدارة</a>
        </div>

        <div id="authArea">
          <img id="authAvatar" alt="avatar" />
          <a id="authLink" class="btn" href="/login">تسجيل الدخول</a>
          <button id="signOutBtn" class="btn" style="display:none">تسجيل الخروج</button>
        </div>
      </div>
    </header>

    <main class="container">
      <slot />
    </main>

    <!-- Auth UI controller: uses the ONE global supabase from /sb-client.js -->
    <script type="module">
      const supabase = (window.getSupabase && window.getSupabase()) || window.__supabase;

      const authLink = document.getElementById("authLink");
      const authAvatar = document.getElementById("authAvatar");
      const signOutBtn = document.getElementById("signOutBtn");
      const adminLink = document.getElementById("adminLink");

      function setSignedOut() {
        if (authAvatar) authAvatar.style.display = "none";
        authLink.textContent = "تسجيل الدخول";
        authLink.href = "/login";
        signOutBtn.style.display = "none";
        if (adminLink) adminLink.style.display = "none";
      }
      function setSignedIn(user) {
        const name = user.user_metadata?.name || user.email || "حسابي";
        authLink.textContent = name;
        authLink.href = "/";
        signOutBtn.style.display = "inline-flex";
        if (authAvatar) {
          authAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}`;
          authAvatar.style.display = "inline-block";
        }
      }

      async function refresh() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) { setSignedOut(); return; }
        setSignedIn(user);

        // roles check (optional table)
        try {
          const { data: roles, error } = await supabase
            .from("roles")
            .select("role")
            .eq("email", user.email);

          if (!error && roles?.some(r => r.role === "admin")) {
            if (adminLink) adminLink.style.display = "inline-block";
          } else {
            if (adminLink) adminLink.style.display = "none";
          }
        } catch { /* ignore if table missing */ }
      }

      refresh();
      supabase.auth.onAuthStateChange((_evt, session) => {
        if (session?.user) { setSignedIn(session.user); refresh(); }
        else { setSignedOut(); }
      });

      signOutBtn?.addEventListener("click", async () => {
        await supabase.auth.signOut();
        setSignedOut();
        location.href = "/";
      });
    </script>
  </body>
</html>
