---
import Base from "@/layouts/Base.astro";

// Load chapters & group by novel
const files = import.meta.glob("/src/content/novels/**/*.md", { eager: true }) as Record<string, any>;

type FM = { novel?: string; slug?: string; chapter?: number; cover?: string; summary?: string; description?: string; };

const bySlug = new Map<string, {
  title: string; slug: string; cover: string; count: number; latest: number; description: string;
}>();

const allChapters: Array<{slug:string; chapter:number; title:string}> = [];

for (const mod of Object.values(files)) {
  const fm: FM = mod.frontmatter ?? {};
  if (!fm.slug) continue;

  const entry = bySlug.get(fm.slug) ?? {
    title: fm.novel ?? fm.slug,
    slug: fm.slug,
    cover: fm.cover ?? "/cover3.png",
    count: 0,
    latest: 0,
    description: fm.description ?? "",
  };
  entry.count += 1;
  entry.latest = Math.max(entry.latest, Number(fm.chapter ?? 0));
  bySlug.set(fm.slug, entry);

  // list for "latest"
  const t = fm.title ?? `الفصل ${fm.chapter ?? ""}`;
  const cnum = Number(fm.chapter ?? 0);
  if (Number.isFinite(cnum)) allChapters.push({ slug: fm.slug, chapter: cnum, title: t });
}

const novels = Array.from(bySlug.values()).sort((a,b)=> a.slug.localeCompare(b.slug));
allChapters.sort((a,b)=> b.chapter - a.chapter);
const latest = allChapters.slice(0, 6);

// For hero: use first novel (if exists)
const hero = novels[0];
const novelTitle = hero?.title ?? "كاره الشوجو";
const novelSlug = hero?.slug ?? "karih-al-shoujo";
const heroCover = hero?.cover ?? "/cover3.png";
const heroDesc  = hero?.description ?? "كل شيء ضبابي… حتى الحقيقة. ادخل عالم «كاره الشوجو»، حيث تتقاطع القوى والقدر.";
---

<Base title="الرئيسية — موقع الروايات" description={novelTitle}>

  <!-- === Mystery Hero === -->
  <section class="hero-mystery" dir="rtl">
    <div class="veil"></div>
    <div class="hero-content">
      <h1>غموضٌ يبتلعُ اليقين</h1>
      <p class="tagline">خطوةٌ واحدة… وتستيقظ في عالمٍ تتصارع فيه القوى والقدر.</p>
      <div class="actions">
        <a class="btn" href={`/novels/${novelSlug}`}>ابدأ القراءة</a>
        <a class="btn btn-ghost" href="/novels">كل الروايات</a>
      </div>
    </div>
  </section>

  <!-- LATEST (compact: cover + one sentence) -->
  {latest.length > 0 && (
    <section class="card" style="margin-top:18px; padding:12px;">
      <div class="latest-wrap">
        <img
          src={heroCover}
          alt={`غلاف ${novelTitle}`}
          class="latest-cover"
          loading="lazy"
        />
        <div class="latest-text">
          <h2 style="margin:0 0 8px;">آخر الفصول</h2>
          <p class="muted" style="margin:0;">
            آخر الفصول:&nbsp;
            {
              latest.slice(0, 4).map((it, i) => (
                <>
                  <a href={`/novels/${it.slug}/${it.chapter}`}>الفصل {it.chapter}</a>
                  {i < Math.min(latest.length, 4) - 1 && "، "}
                </>
              ))
            }
            &nbsp;— <a href="/novels">عرض الكل</a>
          </p>
        </div>
      </div>

      <style>
        .latest-wrap{
          display:grid;
          grid-template-columns: 140px 1fr;
          gap:12px;
          align-items:center;
        }
        @media (max-width: 560px){
          .latest-wrap{ grid-template-columns: 1fr; }
        }
        .latest-cover{
          width:100%; height:140px; object-fit:cover; border-radius:12px;
          border:1px solid var(--stroke);
        }
        .latest-text a{ color: var(--ink); text-decoration: underline; }
        .latest-text a:hover{ color: var(--accent); }
      </style>
    </section>
  )}

  <!-- NOVELS GRID -->
  <section style="margin-top:18px">
    <h2 style="margin:0 0 10px;">الروايات</h2>
    <div class="grid">
      {novels.map(n => (
        <a class="novel" href={`/novels/${n.slug}`}>
          <img src={n.cover} alt={n.title} loading="lazy" />
          <div class="meta">
            <strong>{n.title}</strong>
            <span class="muted">عدد الفصول: {n.count} — آخر فصل: {n.latest}</span>
          </div>
        </a>
      ))}
    </div>
  </section>

  <style>
    /* --- HERO STYLES --- */
    .hero-mystery{
      position: relative;
      border-radius: 18px;
      overflow: hidden;
      min-height: clamp(220px, 38vh, 420px);
      /* put your image at /public/img/mystery-hero.jpg (keeps working with gradient if missing) */
      background:
        radial-gradient(1200px 420px at 70% -10%, rgba(80,92,130,.25), transparent 60%),
        url('/img/mystery-hero.jpg') center/cover no-repeat,
        linear-gradient(180deg, #0b0f16, #0b0f16);
      border: 1px solid var(--stroke, rgba(255,255,255,.08));
      box-shadow: 0 10px 30px rgba(0,0,0,.35) inset;
      margin-top: 10px;
    }
    .hero-mystery .veil{
      position: absolute; inset: 0;
      background:
        linear-gradient(180deg, rgba(8,12,18,.60), rgba(8,12,18,.85)),
        radial-gradient(900px 320px at 50% 0%, rgba(36,40,60,.35), transparent 60%);
      backdrop-filter: blur(1px);
    }
    .hero-content{
      position: relative; z-index: 1;
      display: grid; place-items: center;
      text-align: center;
      padding: clamp(28px, 6vw, 56px) 16px;
      gap: 12px;
    }
    .hero-content h1{
      margin: 0;
      font-weight: 900;
      letter-spacing: .3px;
      font-size: clamp(26px, 4.5vw, 46px);
    }
    .tagline{
      margin: 4px 0 2px;
      opacity: .9;
      font-size: clamp(14px, 1.7vw, 18px);
    }
    .actions{
      display: flex; gap: 10px; margin-top: 8px;
    }
    .btn{
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 14px; border-radius: 12px;
      background: var(--accent, #5b6cff);
      color: #fff; text-decoration: none; font-weight: 700;
      border: 1px solid rgba(255,255,255,.14);
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .btn-ghost{
      background: transparent;
      color: var(--ink, #e7e8ee);
      border-color: rgba(255,255,255,.18);
    }
    .btn-ghost:hover{ background: rgba(255,255,255,.06); }

    /* --- GRID --- */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 14px;
    }
    .novel{
      display:block; text-decoration:none; color:inherit;
      background:var(--glass); border:1px solid var(--stroke); border-radius:14px;
      overflow:hidden; transition: transform .15s ease, border-color .15s ease;
    }
    .novel:hover{ transform: translateY(-3px); border-color: rgba(255,255,255,.14); }
    .novel img{ width:100%; aspect-ratio: 16/10; object-fit: cover; }
    .meta{ padding:10px 12px; display:flex; flex-direction:column; gap:6px; }
  </style>
</Base>
