---
import Base from "@/layouts/Base.astro";
const e = import.meta.env;
---

<Base title="تسجيل الدخول">
  <section class="card" style="max-width:620px;margin:36px auto;padding:28px;border-radius:20px;">
    <div style="text-align:center;margin-bottom:18px;">
      <h1 style="margin:0 0 6px;font-size:clamp(22px,3vw,32px);font-weight:900;letter-spacing:.2px;">
        تسجيل الدخول
      </h1>
      <p class="muted" style="margin:0;">ادخل عالم كاره الشوجو وتابع فصولك المفضّلة.</p>
    </div>

    <div style="display:grid;gap:14px;">
      <button id="googleBtn"
        style="width:100%;display:inline-flex;align-items:center;justify-content:center;gap:10px;
               border:none;border-radius:14px;cursor:pointer;padding:12px 14px;
               background:linear-gradient(135deg,#6ea8ff 0%,#a475ff 100%);
               color:#001028;font-weight:800;box-shadow:0 6px 20px rgba(110,168,255,.25);">
        المتابعة مع Google
      </button>

      <div class="muted" style="text-align:center;">أو</div>

      <label style="font-weight:700">البريد الإلكتروني</label>
      <input id="email" type="email" placeholder="name@email.com"
        style="padding:12px 14px;border-radius:14px;border:1px solid var(--stroke);
               background:rgba(255,255,255,.06);color:var(--ink);outline:none" />

      <label style="font-weight:700">كلمة المرور</label>
      <input id="password" type="password" placeholder="••••••••"
        style="padding:12px 14px;border-radius:14px;border:1px solid var(--stroke);
               background:rgba(255,255,255,.06);color:var(--ink);outline:none" />

      <div style="display:flex;gap:10px;justify-content:space-between;">
        <button id="emailLogin" class="btn" style="flex:1;padding:12px;border-radius:14px;border:1px solid var(--stroke);
               background:rgba(255,255,255,.12);color:var(--ink);font-weight:700;">
          تسجيل الدخول
        </button>
        <button id="emailRegister" class="btn" style="flex:1;padding:12px;border-radius:14px;border:1px solid var(--stroke);
               background:transparent;color:var(--ink);font-weight:700;">
          إنشاء حساب
        </button>
      </div>

      <button id="logoutBtn" class="btn btn-ghost" style="display:none;">تسجيل الخروج</button>
      <p id="msg" class="muted" style="min-height:1.2em;text-align:center;margin:6px 0 0;"></p>
    </div>
  </section>

  <!-- Pure CDN client-side logic: no bundling, no /src paths -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey:        ${JSON.stringify(e.PUBLIC_FIREBASE_API_KEY)},
      authDomain:    ${JSON.stringify(e.PUBLIC_FIREBASE_AUTH_DOMAIN)},
      projectId:     ${JSON.stringify(e.PUBLIC_FIREBASE_PROJECT_ID)},
      storageBucket: ${JSON.stringify(e.PUBLIC_FIREBASE_STORAGE_BUCKET)},
      appId:         ${JSON.stringify(e.PUBLIC_FIREBASE_APP_ID)},
    };

    const app   = initializeApp(firebaseConfig);
    const auth  = getAuth(app);
    const gProv = new GoogleAuthProvider();

    const $ = (s) => document.querySelector(s);
    const googleBtn = $("#googleBtn");
    const emailLogin = $("#emailLogin");
    const emailRegister = $("#emailRegister");
    const logoutBtn = $("#logoutBtn");
    const email = $("#email");
    const password = $("#password");
    const msg = $("#msg");
    const show = (t) => { if (msg) msg.textContent = t || ""; };

    googleBtn?.addEventListener("click", async () => {
      show("جاري تسجيل الدخول…");
      try {
        await signInWithPopup(auth, gProv);
        window.location.assign("/");
      } catch (e) {
        console.error(e); show(e?.message || e?.code || "حدث خطأ");
      }
    });

    emailLogin?.addEventListener("click", async () => {
      show("…");
      try {
        await signInWithEmailAndPassword(auth, email.value.trim(), password.value);
        window.location.assign("/");
      } catch (e) {
        console.error(e); show(e?.message || e?.code || "حدث خطأ");
      }
    });

    emailRegister?.addEventListener("click", async () => {
      show("…");
      try {
        await createUserWithEmailAndPassword(auth, email.value.trim(), password.value);
        window.location.assign("/");
      } catch (e) {
        console.error(e); show(e?.message || e?.code || "حدث خطأ");
      }
    });

    logoutBtn?.addEventListener("click", async () => {
      await signOut(auth);
      show("تم تسجيل الخروج.");
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        if (logoutBtn) logoutBtn.style.display = "inline-flex";
        show(`مرحبًا ${user.displayName || user.email}`);
        if (location.pathname === "/login") window.location.replace("/");
      } else {
        if (logoutBtn) logoutBtn.style.display = "none";
        show("");
      }
    });
  </script>
</Base>
