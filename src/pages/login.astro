<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // Read from meta tags filled by Base.astro
  const SB_URL = document.querySelector('meta[name="x-sb-url"]')?.content || "";
  const SB_KEY = document.querySelector('meta[name="x-sb-key"]')?.content || "";

  // Create a SINGLE client and reuse it
  const supabase =
    window.__sb ??= createClient(SB_URL, SB_KEY, {
      auth: { persistSession: true, storageKey: "karih-auth" }
    });

  const $ = (s)=>document.querySelector(s);
  const email = $("#email");
  const password = $("#password");
  const emailLogin = $("#emailLogin");
  const emailRegister = $("#emailRegister");
  const googleBtn = $("#googleBtn");
  const msg = $("#msg");
  const show = (t)=>{ if (msg) msg.textContent = t || ""; };

  // If already signed in, go home
  (async ()=>{
    const { data: { user } } = await supabase.auth.getUser();
    if (user) location.replace("/");
  })();

  emailLogin?.addEventListener("click", async ()=>{
    show("…");
    const { error } = await supabase.auth.signInWithPassword({
      email: email.value.trim(),
      password: password.value
    });
    if (error) show(error.message); else location.href = "/";
  });

  emailRegister?.addEventListener("click", async ()=>{
    show("…");
    const { error } = await supabase.auth.signUp({
      email: email.value.trim(),
      password: password.value
    });
    if (error) show(error.message);
    else show("تم إنشاء الحساب ✅ — افحص بريدك إذا طُلِب التأكيد");
  });

  // IMPORTANT: no redirectTo here; Supabase uses your Site URL
  googleBtn?.addEventListener("click", async ()=>{
    show("جارٍ فتح Google…");
    const { error } = await supabase.auth.signInWithOAuth({ provider: "google" });
    if (error) show(error.message);
  });

  supabase.auth.onAuthStateChange((_evt, session)=>{
    if (session?.user) location.replace("/");
  });
</script>
