---
import Base from "@/layouts/Base.astro";
---

<Base title="تسجيل الدخول">
  <section class="card" style="max-width:560px;margin:28px auto;padding:22px;">
    <h1 style="margin:0 0 8px; text-align:center;">تسجيل الدخول</h1>
    <p class="muted" style="text-align:center; margin:0 0 16px;">
      ادخل عالم كاره الشوجو وتابع فصولك المفضّلة.
    </p>

    <div style="display:grid; gap:10px;">
      <button id="googleBtn" class="btn" style="width:100%;">المتابعة مع Google</button>

      <div class="muted" style="text-align:center;">أو</div>

      <label>البريد الإلكتروني</label>
      <input id="email" type="email" placeholder="name@email.com"
             style="padding:10px;border-radius:10px;border:1px solid var(--stroke);background:transparent;color:var(--ink);" />

      <label>كلمة المرور</label>
      <input id="password" type="password" placeholder="••••••••"
             style="padding:10px;border-radius:10px;border:1px solid var(--stroke);background:transparent;color:var(--ink);" />

      <div style="display:flex; gap:8px; justify-content:space-between;">
        <button id="emailLogin" class="btn" style="flex:1;">تسجيل الدخول</button>
        <button id="emailRegister" class="btn btn-ghost" style="flex:1;">إنشاء حساب</button>
      </div>

      <button id="logoutBtn" class="btn btn-ghost" style="display:none;">تسجيل الخروج</button>

      <p id="msg" class="muted" style="min-height:1.2em;text-align:center;margin:6px 0 0;"></p>
    </div>
  </section>

  <!-- Page logic -->
  <script type="module">
    import { auth, googleProvider } from "/src/lib/firebase.js";
    import {
      signInWithPopup,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
    } from "firebase/auth";

    const $ = (s) => document.querySelector(s);
    const googleBtn = $("#googleBtn");
    const emailLogin = $("#emailLogin");
    const emailRegister = $("#emailRegister");
    const logoutBtn = $("#logoutBtn");
    const email = $("#email");
    const password = $("#password");
    const msg = $("#msg");

    const show = (t) => { msg.textContent = t || ""; };

    googleBtn?.addEventListener("click", async () => {
      show("جاري تسجيل الدخول…");
      try {
        await signInWithPopup(auth, googleProvider);
        show("تم تسجيل الدخول ✅");
        window.location.href = "/"; // redirect
      } catch (e) {
        show(e?.message || e?.code || "حدث خطأ");
        console.error(e);
      }
    });

    emailLogin?.addEventListener("click", async () => {
      show("…");
      try {
        await signInWithEmailAndPassword(auth, email.value.trim(), password.value);
        show("تم تسجيل الدخول ✅");
        window.location.href = "/"; // redirect
      } catch (e) {
        show(e?.message || e?.code || "حدث خطأ");
        console.error(e);
      }
    });

    emailRegister?.addEventListener("click", async () => {
      show("…");
      try {
        await createUserWithEmailAndPassword(auth, email.value.trim(), password.value);
        show("تم إنشاء الحساب ✅");
        window.location.href = "/"; // redirect
      } catch (e) {
        show(e?.message || e?.code || "حدث خطأ");
        console.error(e);
      }
    });

    logoutBtn?.addEventListener("click", async () => {
      await signOut(auth);
      show("تم تسجيل الخروج.");
    });

    // If user already signed in, bounce to home
    onAuthStateChanged(auth, (user) => {
      if (user) {
        logoutBtn.style.display = "inline-flex";
        show(`مرحبًا ${user.displayName || user.email}`);
        // If you prefer instant redirect when signed in:
        if (location.pathname === "/login") window.location.replace("/");
      } else {
        logoutBtn.style.display = "none";
        show("");
      }
    });
  </script>
</Base>
