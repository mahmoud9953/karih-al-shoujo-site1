---
import Base from '../layouts/Base.astro';
---

<Base title="تسجيل الدخول">
  <h1 style="text-align:center;margin:2rem 0;">تسجيل الدخول</h1>

  <div class="card" style="max-width:420px;margin:0 auto;text-align:center;gap:12px;display:grid;">
    <button id="googleBtn">التسجيل مع Google</button>

    <input id="email" type="email" placeholder="البريد الإلكتروني" dir="ltr" />
    <input id="password" type="password" placeholder="كلمة المرور" dir="ltr" />

    <div style="display:flex; gap:8px; justify-content:center;">
      <button id="emailLogin">تسجيل الدخول</button>
      <button id="emailRegister">تسجيل جديد</button>
    </div>

    <button id="logoutBtn">تسجيل الخروج</button>
    <p id="msg" style="min-height:1.5em"></p>
  </div>

  <style>
    button{ transition: transform 120ms ease, filter 120ms ease; }
    button:active{ transform: scale(.98); filter: brightness(.95); }
    button:focus-visible{ outline:2px solid #8ab4f8; outline-offset:2px; }
    input{ padding:.6rem .8rem; border-radius:.6rem; border:1px solid #444; background:#111; color:#eee; }
    .card button{ padding:.6rem .8rem; border-radius:.6rem; border:1px solid #444; background:#222; color:#eee; }
  </style>

  <!-- Inline module: no external /login.js will be requested -->
  <script type="module">
    import { auth, googleProvider } from '../lib/firebase.js';
    import {
      signInWithPopup,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from 'firebase/auth';

    const $ = (sel) => document.querySelector(sel);
    const googleBtn     = $('#googleBtn');
    const emailLogin    = $('#emailLogin');
    const emailRegister = $('#emailRegister');
    const logoutBtn     = $('#logoutBtn');
    const email         = $('#email');
    const password      = $('#password');
    const msg           = $('#msg');
    const show = (t) => { msg.textContent = t || ''; };

    googleBtn?.addEventListener('click', async () => {
      show('جاري تسجيل الدخول...');
      try {
        await signInWithPopup(auth, googleProvider);
        show('تم تسجيل الدخول بنجاح ✅');
      } catch (e) {
        show(e?.message || e?.code || 'خطأ في تسجيل الدخول');
        console.error(e);
      }
    });

    emailLogin?.addEventListener('click', async () => {
      show('...');
      try {
        await signInWithEmailAndPassword(auth, email.value.trim(), password.value);
        show('تم تسجيل الدخول ✅');
      } catch (e) {
        show(e?.message || e?.code || 'خطأ في تسجيل الدخول بالبريد');
        console.error(e);
      }
    });

    emailRegister?.addEventListener('click', async () => {
      show('...');
      try {
        await createUserWithEmailAndPassword(auth, email.value.trim(), password.value);
        show('تم إنشاء الحساب وتسجيل الدخول ✅');
      } catch (e) {
        show(e?.message || e?.code || 'خطأ في إنشاء الحساب');
        console.error(e);
      }
    });

    logoutBtn?.addEventListener('click', async () => {
      await signOut(auth);
      show('تم تسجيل الخروج.');
    });

    onAuthStateChanged(auth, (user) => {
      if (user) show('مسجّل دخول: ' + (user.email || user.displayName || 'مستخدم'));
      else show('');
    });
  </script>
</Base>
