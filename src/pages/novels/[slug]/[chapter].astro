---
import Base from "@/layouts/Base.astro";
import { getEntry } from "astro:content";

const { slug = "", chapter = "" } = Astro.params;

// 1. Get the specific chapter entry from the collection
// The ID will be "karih-al-shoujo/001-المقدمة"
const entry = await getEntry("novels", `${slug}/${chapter}`);

const notFound = !entry;

// 2. If we found it, render the content and get the frontmatter
let Content, fm;
if (entry) {
  const rendered = await entry.render();
  Content = rendered.Content;
  fm = entry.data;
}

const title = fm
  ? `${fm.title || `الفصل ${chapter}`} — ${fm.novel || fm.slug}`
  : "غير موجود";
---

<Base title={title} description={fm?.summary || ""}>
  {notFound ? (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <h1 style="margin-top:0">غير موجود</h1>
      <p class="muted">لم نعثر على هذا الفصل.</p>
      
      <details style="margin-top:10px">
        <summary>تفاصيل تصحيح</summary>
        <p>Astro tried to find this content entry:</p>
        <code>src/content/novels/{slug}/{chapter}.md</code>
      </details>

      <p><a href={`/novels/${slug}`}>العودة إلى الفصول</a></p>
    </section>
  ) : (
    <article class="card" style="margin:18px 0;padding:22px;border-radius:16px;">
      <header style="margin-bottom:14px">
        <h1 style="margin:0 0 6px">{fm.title || `الفصل ${chapter}`}</h1>
        <p class="muted" style="margin:0">
          {fm.novel || fm.slug} — {fm.title}
        </p>
      </header>

      <Content />

      <footer style="margin-top:18px">
        <a class="muted" href={`/novels/${slug}`}>◀ العودة إلى فصول {fm.novel || fm.slug}</a>
      </footer>
    </article>
  )}
</Base>