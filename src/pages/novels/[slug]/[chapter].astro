---
import Base from "@/layouts/Base.astro";
import { getCollection } from "astro:content";

const { slug = "", chapter = "" } = Astro.params;
const novelSlug = String(slug).trim();
const chapterNum = Number(chapter);

// 1. Get all chapters of this novel
const chapters = await getCollection(
  "novels",
  (entry) => entry.data.novelSlug === novelSlug
);

// 2. Find the specific chapter by its number
const entry = chapters.find(
  (item) => Number(item.data.chapter) === chapterNum
);

const notFound = !entry;

// 3. Render content if found
let Content, fm;
if (entry) {
  const rendered = await entry.render();
  Content = rendered.Content;
  fm = entry.data;
}

const title = fm
  ? `${fm.title || `الفصل ${chapter}`} — ${fm.novel || novelSlug}`
  : "غير موجود";
---

<Base title={title} description={fm?.summary || ""}>
  {notFound ? (
    <section
      class="card"
      style="margin:18px 0;padding:20px;border-radius:16px;"
    >
      <h1 style="margin-top:0">غير موجود</h1>
      <p class="muted">لم نعثر على هذا الفصل.</p>

      <details style="margin-top:10px">
        <summary>Debug info</summary>
        <p>Looking for chapter <code>{chapterNum}</code> of novel <code>{novelSlug}</code>.</p>
        <p>Make sure <code>novelSlug</code> and <code>chapter</code> in the frontmatter match.</p>
      </details>

      <p>
        <a href={`/novels/${novelSlug}`}>العودة إلى الفصول</a>
      </p>
    </section>
  ) : (
    <article
      class="card"
      style="margin:18px 0;padding:22px;border-radius:16px;"
    >
      <header style="margin-bottom:14px">
        <h1 style="margin:0 0 6px">{fm.title || `الفصل ${chapter}`}</h1>
        <p class="muted" style="margin:0">
          {fm.novel || novelSlug} — {fm.title}
        </p>
      </header>

      <Content />

      <footer style="margin-top:18px">
        <a class="muted" href={`/novels/${novelSlug}`}>
          ◀ العودة إلى فصول {fm.novel || novelSlug}
        </a>
      </footer>
    </article>
  )}
</Base>
