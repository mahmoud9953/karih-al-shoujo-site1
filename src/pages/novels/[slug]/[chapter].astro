---
import Base from "@/layouts/Base.astro";

// URL params
const { slug = "", chapter = "" } = Astro.params;

// Load all MD files under /src/content/novels (nested OK)
const files = import.meta.glob("/src/content/novels/**/*.md", { eager: true }) as Record<string, any>;

// Find the one that matches slug + chapter
function pick() {
  const wantSlug = String(slug);
  const wantChap = Number(chapter);
  for (const mod of Object.values(files)) {
    const fm = (mod as any).frontmatter ?? {};
    if (String(fm.slug) === wantSlug && Number(fm.chapter) === wantChap) {
      return { fm, Content: (mod as any).default };
    }
  }
  return null;
}

const found = pick();
const notFound = !found;
const title = found ? `${found.fm.title || `الفصل ${chapter}`} — ${found.fm.novel || found.fm.slug}` : "غير موجود";
---

<Base title={title} description={found?.fm.summary || ""}>
  {notFound ? (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <h1 style="margin-top:0">غير موجود</h1>
      <p class="muted">لم نعثر على هذا الفصل. تأكّد من وجود الملف وأن الـ <code>slug</code> و <code>chapter</code> في الـ frontmatter صحيحان.</p>
      <p><a href={`/novels/${slug}`}>العودة إلى كل الفصول</a></p>
    </section>
  ) : (
    <article class="card" style="margin:18px 0;padding:22px;border-radius:16px;">
      <header style="margin-bottom:14px">
        <h1 style="margin:0 0 6px">{found!.fm.title || `الفصل ${chapter}`}</h1>
        <p class="muted" style="margin:0">
          {found!.fm.novel || found!.fm.slug} — الفصل {chapter}
        </p>
      </header>

      <found!.Content />

      <footer style="margin-top:18px">
        <a class="muted" href={`/novels/${slug}`}>◀ العودة إلى فصول {found!.fm.novel || found!.fm.slug}</a>
      </footer>
    </article>
  )}
</Base>
