---
import Base from "@/layouts/Base.astro";

const { slug = "", chapter = "" } = Astro.params;

// normalize URL params
const wantSlug = String(slug).trim();
const wantChapS = String(chapter).trim(); // This will be "001", "003.5", etc.
const wantChapN = Number(wantChapS);

const files = import.meta.glob("/src/content/novels/**/*.md", { eager: true }) as Record<string, any>;

function deriveFromPath(path: string) {
  const parts = path.split("/");
  const slugFromPath = parts[4] || "";
  const fileName = parts[5] || "";
  
  // This regex will match "001", "003", and "003.5" from your filenames
  const m = fileName.match(/^(\d+\.?\d*)/); 

  const chapFromPathN = m ? Number(m[1]) : NaN;
  const chapFromPathS = m ? String(m[1]) : String(chapFromPathN);
  
  return {
    slugFromPath: String(slugFromPath).trim(),
    chapFromPathN,
    chapFromPathS: chapFromPathS, // This is "003" or "003.5"
  };
}

type Found = {
  fm: any;
  Content: any;
};

function pick(): Found | null {
  for (const [path, mod] of Object.entries(files)) {
    const fm = (mod as any).frontmatter ?? {};
    const { slugFromPath, chapFromPathN, chapFromPathS } = deriveFromPath(path);

    // This will skip files that don't match
    if (!chapFromPathS) continue;

    const fmSlugS = String(fm.slug ?? "").trim() || slugFromPath;
    const fmChapS = String(fm.chapter ?? "").trim() || chapFromPathS;
    const fmChapN = Number(fm.chapter ?? chapFromPathN);

    // This will now check "003" === "003" OR 3 === 3
    const chapMatch =
      (Number.isFinite(wantChapN) && Number.isFinite(fmChapN) && fmChapN === wantChapN) ||
      fmChapS === wantChapS;

    if (fmSlugS === wantSlug && chapMatch) {
      return { fm: { ...fm, slug: fmSlugS, chapter: fmChapN || fmChapS }, Content: (mod as any).default };
    }
  }
  return null;
}

const found = pick();
const notFound = !found;

const title = found
  ? `${found.fm.title || `الفصل ${wantChapS}`} — ${found.fm.novel || found.fm.slug}`
  : "غير موجود";
---

<Base title={title} description={found?.fm.summary || ""}>
  {notFound ? (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <h1 style="margin-top:0">غير موجود</h1>
      <p class="muted">لم نعثر على هذا الفصل.</p>

      <details style="margin-top:10px">
        <summary>تفاصيل تصحيح</summary>
        <ul>
          <li>Looking for slug: <code>{wantSlug}</code></li>
          <li>Looking for chapter: <code>{wantChapS}</code></li>
        </ul>
        <p>الفصول التي اكتشفها النظام:</p>
        <pre style="white-space:pre-wrap;max-height:220px;overflow:auto">
{JSON.stringify(
  Object.entries(files).map(([p,m]: any) => {
    const fm = m.frontmatter ?? {};
    const d = deriveFromPath(p);
    return {
      path: p.replace(/^.*\/src\/content\/novels\//, "…/"),
      slug: fm.slug || d.slugFromPath,
      chapter_string: d.chapFromPathS,
      chapter_num: d.chapFromPathN,
      fm_chapter: fm.chapter || null,
    };
  }),
  null, 2)}
        </pre>
      </details>

      <p><a href={`/novels/${slug}`}>العودة إلى الفصول</a></p>
    </section>
  ) : (
    <article class="card" style="margin:18px 0;padding:22px;border-radius:16px;">
      <header style="margin-bottom:14px">
        <h1 style="margin:0 0 6px">{found!.fm.title || `الفصل ${wantChapS}`}</h1>
        <p class="muted" style="margin:0">
          {found!.fm.novel || found!.fm.slug} — الفصل {wantChapS}
        </p>
      </header>

      <found!.Content />

      <footer style="margin-top:18px">
        <a class="muted" href={`/novels/${slug}`}>◀ العودة إلى فصول {found!.fm.novel || found!.slug}</a>
      </footer>
    </article>
  )}
</Base>