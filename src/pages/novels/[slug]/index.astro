---
import Base from "@/layouts/Base.astro";
import { getCollection } from "astro:content";

const { slug = "" } = Astro.params;
const wantSlug = String(slug).trim();

// 1. هات كل الفصول اللي belong لنفس الرواية حسب الـ frontmatter.slug
const novelChapters = await getCollection(
  "novels",
  (entry) => entry.data.slug === wantSlug
);

// 2. جهّز بيانات العرض
const rows = novelChapters.map((entry) => {
  const chapterN = entry.data.chapter; // رقم الفصل من الـ frontmatter

  return {
    chapterN,
    title: entry.data.title,
    url: `/novels/${wantSlug}/${chapterN}`, // لاحظ: هنا بس رقم واحد للفصل
    publishedAt: entry.data.publishedAt,
  };
});

// 3. ترتيب الفصول حسب رقم الفصل
rows.sort((a, b) => a.chapterN - b.chapterN);

// 4. هل وجدنا فصول؟
const notFound = rows.length === 0;

// ميتاداتا للرأس
let novelTitleDisplay = wantSlug;
let description = "";
let cover = "/cover3.png";

if (!notFound) {
  novelTitleDisplay = novelChapters[0].data.novel || wantSlug;
  description = novelChapters[0].data.description || "";
  cover = novelChapters[0].data.cover || cover;
}

const pageTitle = notFound ? "غير موجود" : `فصول ${novelTitleDisplay}`;
---

<Base title={pageTitle} description={description}>
  {notFound ? (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <h1 style="margin:0 0 6px">غير موجود</h1>
      <p class="muted">
        لا توجد فصول للرواية ذات المعرّف <code>{wantSlug}</code>.
      </p>
      <p class="muted">
        Astro يبحث عن الملفات في <code>src/content/novels/</code>.
      </p>
    </section>
  ) : (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <div style="display:flex;gap:14px;align-items:center;margin-bottom:10px">
        <img
          src={cover}
          alt={novelTitleDisplay}
          style="width:88px;height:88px;object-fit:cover;border-radius:12px;border:1px solid var(--stroke)"
        />
        <div>
          <h1 style="margin:0 0 6px">{novelTitleDisplay}</h1>
          {description && (
            <p class="muted" style="margin:0">
              {description}
            </p>
          )}
        </div>
      </div>

      <ol style="margin:0;padding-inline-start:18px;display:grid;gap:6px">
        {rows.map((r) => (
          <li>
            <a href={r.url}>{r.title}</a>
            {r.publishedAt && (
              <span class="muted" style="margin-inline-start:8px">
                — {r.publishedAt}
              </span>
            )}
          </li>
        ))}
      </ol>
    </section>
  )}
</Base>
