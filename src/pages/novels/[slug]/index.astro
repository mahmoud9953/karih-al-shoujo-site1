---
import Base from "@/layouts/Base.astro";

/** REQUIRED for static build of dynamic [slug] route */
export function getStaticPaths() {
  // 1) Load all chapters (eager = at build time)
  const mods = import.meta.glob("/src/content/novels/*/*.md", { eager: true });

  // 2) Build a registry per novel slug
  const reg = new Map(); // Map<string, any[]>
  for (const [path, mod] of Object.entries(mods)) {
    const fm = (mod as any).frontmatter || {};

    // derive slug from folder name
    const slugMatch = path.match(/\/src\/content\/novels\/([^/]+)\//);
    const slug = slugMatch ? slugMatch[1] : "unknown";

    // derive chapter number if not in frontmatter
    const fileName = path.match(/\/([^/]+)\.md$/)?.[1] ?? "";
    const parsedNum = Number(fileName.replace(/[^0-9.]/g, ""));
    const chapter =
      Number.isFinite(fm.chapter) ? fm.chapter :
      (Number.isFinite(parsedNum) ? parsedNum : 0);

    const item = {
      ...fm,
      slug,
      chapter,
      novel: fm.novel ?? slug,
      title: fm.title ?? `الفصل ${chapter}`,
    };

    const arr = reg.get(slug) ?? [];
    arr.push(item);
    reg.set(slug, arr);
  }

  // 3) Sort and return static paths
  const paths = [];
  for (const [slug, chapters] of reg.entries()) {
    chapters.sort((a, b) => (a.chapter ?? 0) - (b.chapter ?? 0));
    const meta = chapters[0] ?? {};
    paths.push({
      params: { slug },
      props: {
        slug,
        chapters,
        title: meta.novel ?? slug,
        cover: meta.cover ?? "/cover3.png",
        description: meta.description ?? "",
      },
    });
  }
  return paths;
}

// Props from getStaticPaths
const {
  slug,
  chapters = [],
  title = "رواية",
  cover = "/cover3.png",
  description = "",
} = Astro.props;
---

<Base title={`${title} — الفصول`} description={description}>
  <nav style="display:flex; gap:.75rem; align-items:center; margin-bottom:1rem;">
    <a href="/" class="muted">الرئيسية</a>
    <span class="muted">/</span>
    <a href="/novels" class="muted">كل الروايات</a>
    <span class="muted">/</span>
    <strong>{title}</strong>
  </nav>

  <section class="card" style="padding:16px;">
    <div style="display:flex; gap:16px; align-items:center;">
      <img src={cover} alt={`غلاف ${title}`} width="96" height="96" style="border-radius:12px; object-fit:cover;" />
      <div>
        <h1 style="margin:.25rem 0 0">{title}</h1>
        {description && <p class="muted" style="margin:.25rem 0 0; max-width:60ch;">{description}</p>}
      </div>
    </div>

    <hr style="margin:16px 0; opacity:.15;" />

    {chapters.length === 0 ? (
      <p class="muted">لا توجد فصول بعد.</p>
    ) : (
      <ol style="padding-inline-start:1.25rem; text-align:right;">
        {chapters.map((c: any) => (
          <li style="margin:.4rem 0;">
            <a href={`/novels/${slug}/${c.chapter}`}>الفصل {c.chapter}: {c.title}</a>
            {c.summary && <span class="muted"> — {c.summary}</span>}
          </li>
        ))}
      </ol>
    )}
  </section>
</Base>
