---
import Base from "@/layouts/Base.astro";
import { getCollection } from "astro:content";

const { slug = "" } = Astro.params;
const novelSlug = String(slug).trim();

// 1. Get all chapters
const allChapters = await getCollection("novels");

// 2. Keep only chapters of this novel
const novelChapters = allChapters.filter((entry) => {
  return entry.data.novelSlug === novelSlug;  // ⬅️ use novelSlug from frontmatter
});

// 3. Prepare rows
const rows = novelChapters.map((entry) => {
  const chapterN = entry.data.chapter;

  return {
    chapterN,
    title: entry.data.title,
    url: `/novels/${novelSlug}/${chapterN}`,   // /novels/karih-al-shoujo/6
    publishedAt: entry.data.publishedAt,
  };
});

// 4. Sort by chapter number
rows.sort((a, b) => a.chapterN - b.chapterN);

// 5. Not found?
const notFound = rows.length === 0;

// Header info
let novelTitleDisplay = novelSlug;
let description = "";
let cover = "/cover3.png";

if (!notFound) {
  novelTitleDisplay = novelChapters[0].data.novel || novelSlug;
  description = novelChapters[0].data.description || "";
  cover = novelChapters[0].data.cover || cover;
}

const pageTitle = notFound ? "غير موجود" : `فصول ${novelTitleDisplay}`;
---

<Base title={pageTitle} description={description}>
  {notFound ? (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <h1 style="margin:0 0 6px">غير موجود</h1>
      <p class="muted">
        لا توجد فصول للرواية ذات المعرّف <code>{novelSlug}</code>.
      </p>
    </section>
  ) : (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <div style="display:flex;gap:14px;align-items:center;margin-bottom:10px">
        <img
          src={cover}
          alt={novelTitleDisplay}
          style="width:88px;height:88px;object-fit:cover;border-radius:12px;border:1px solid var(--stroke)"
        />
        <div>
          <h1 style="margin:0 0 6px">{novelTitleDisplay}</h1>
          {description && (
            <p class="muted" style="margin:0">{description}</p>
          )}
        </div>
      </div>

      <ol style="margin:0;padding-inline-start:18px;display:grid;gap:6px">
        {rows.map((r) => (
          <li>
            <a href={r.url}>{r.title}</a>
            {r.publishedAt && (
              <span class="muted" style="margin-inline-start:8px">
                — {r.publishedAt}
              </span>
            )}
          </li>
        ))}
      </ol>
    </section>
  )}
</Base>
