---
import Base from "@/layouts/Base.astro";

/** Build a registry of novels from markdown files */
const mods = import.meta.glob("/src/content/novels/*/*.md", { eager: true });

function buildRegistry() {
  /** registry: { [slug: string]: Array<FM> } */
  const reg = new Map();
  for (const [path, mod] of Object.entries(mods)) {
    // slug is the folder name after /novels/
    const m = path.match(/\/src\/content\/novels\/([^/]+)\//);
    const slug = m?.[1] ?? "unknown";

    const fm = (mod as any).frontmatter || {};
    // derive chapter number from filename if not provided
    const fileChap = path.match(/\/([^/]+)\.md$/)?.[1] ?? "";
    const chNum = Number(fileChap.replace(/[^0-9.]/g, ""));
    const chapter = Number.isFinite(fm.chapter) ? fm.chapter : (Number.isFinite(chNum) ? chNum : 0);

    const item = {
      ...fm,
      slug,
      chapter,
      // sensible fallbacks
      novel: fm.novel ?? slug,
      title: fm.title ?? `الفصل ${chapter}`
    };

    const arr = reg.get(slug) ?? [];
    arr.push(item);
    reg.set(slug, arr);
  }

  // sort chapters inside each novel
  for (const [k, v] of reg) {
    v.sort((a: any, b: any) => (a.chapter ?? 0) - (b.chapter ?? 0));
    reg.set(k, v);
  }
  return reg;
}

const REGISTRY = buildRegistry();

/** REQUIRED for static build of dynamic route */
export function getStaticPaths() {
  return Array.from(REGISTRY.keys()).map((slug) => {
    const chapters = REGISTRY.get(slug) ?? [];
    const meta = chapters[0] ?? {};
    return {
      params: { slug },
      props: {
        slug,
        chapters,
        title: meta.novel ?? slug,
        cover: meta.cover ?? "/cover3.png",
        description: meta.description ?? ""
      }
    };
  });
}

const { slug, chapters = [], title = "رواية", cover = "/cover3.png", description = "" } = Astro.props;
---

<Base title={`${title} — الفصول`} description={description}>
  <nav style="display:flex; gap:.75rem; align-items:center; margin-bottom:1rem;">
    <a href="/" class="muted">الرئيسية</a>
    <span class="muted">/</span>
    <a href="/novels" class="muted">كل الروايات</a>
    <span class="muted">/</span>
    <strong>{title}</strong>
  </nav>

  <section class="card" style="padding:16px;">
    <div style="display:flex; gap:16px; align-items:center;">
      <img src={cover} alt={`غلاف ${title}`} width="96" height="96" style="border-radius:12px; object-fit:cover;" />
      <div>
        <h1 style="margin:.25rem 0 0">{title}</h1>
        {description && <p class="muted" style="margin:.25rem 0 0; max-width:60ch;">{description}</p>}
      </div>
    </div>

    <hr style="margin:16px 0; opacity:.15;" />

    {chapters.length === 0 ? (
      <p class="muted">لا توجد فصول بعد.</p>
    ) : (
      <ol style="padding-inline-start:1.25rem; text-align:right;">
        {chapters.map((c: any) => (
          <li style="margin:.4rem 0;">
            <a href={`/novels/${slug}/${c.chapter}`}>الفصل {c.chapter}: {c.title}</a>
            {c.summary && <span class="muted"> — {c.summary}</span>}
          </li>
        ))}
      </ol>
    )}
  </section>
</Base>
