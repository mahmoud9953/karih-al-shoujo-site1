---
import Base from "@/layouts/Base.astro";

// Build the list of *slugs* at build time
export async function getStaticPaths() {
  const all = import.meta.glob("/src/content/novels/**/*.md", { eager: true });
  // collect unique slugs from frontmatter
  const slugs = new Set<string>();
  for (const mod of Object.values(all) as any[]) {
    const fm = mod.frontmatter || {};
    if (fm.slug) slugs.add(fm.slug);
  }
  return Array.from(slugs).map((slug) => ({ params: { slug } }));
}

// Page data
const { slug } = Astro.params;

// Load all chapters then filter to this slug
const all = import.meta.glob("/src/content/novels/**/*.md", { eager: true });
type FM = { title?: string; novel?: string; slug?: string; chapter?: number; summary?: string };
const chapters: FM[] = [];

for (const mod of Object.values(all) as any[]) {
  const fm: FM = mod.frontmatter || {};
  if (fm.slug === slug) chapters.push(fm);
}

chapters.sort((a, b) => (a.chapter ?? 0) - (b.chapter ?? 0));
const title = chapters[0]?.novel || slug;
---

<Base title={`${title} — فهرس الفصول`} description={`فهرس فصول ${title}`}>
  <h1>{title}</h1>
  <p class="muted">فهرس الفصول</p>

  <div class="card" style="margin-top:1rem;">
    <ol class="toc" id="toc">
      {chapters.map((c)=>(
        <li>
          <a href={`/novels/${slug}/${c.chapter}`}>
            الفصل {c.chapter}: {c.title ?? `الفصل ${c.chapter}`}
          </a>
          <img src="/cover.png" alt="غلاف رواية كاره الشوجو"
     style="width:100%;border-radius:16px;margin:1rem 0;" />
          {c.summary && <span class="muted"> — {c.summary}</span>}
        </li>
      ))}
    </ol>
  </div>
</Base>
