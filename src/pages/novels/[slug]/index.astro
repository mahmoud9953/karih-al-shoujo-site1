---
import Base from "@/layouts/Base.astro";

const { slug = "" } = Astro.params;
const wantSlug = String(slug).trim();

const files = import.meta.glob("/src/content/novels/**/*.md", { eager: true }) as Record<string, any>;

type Row = { chapter:number; title:string; url:string; publishedAt?:string };

const rows: Row[] = [];
let novelTitle = "";
let cover = "/cover3.png";
let description = "";

// same path helper
function deriveFromPath(path: string) {
  const parts = path.split("/");
  const slugFromPath = parts[4] || "";
  const fileName     = parts[5] || "";
  const m = fileName.match(/^(\d+)|-(\d+)\./) || fileName.match(/(\d+)(?=\.md$)/);
  const chapFromPathN = m ? Number(m[1] ?? m[2]) : NaN;
  return { slugFromPath: String(slugFromPath).trim(), chapFromPathN };
}

for (const [path, mod] of Object.entries(files)) {
  const fm = (mod as any).frontmatter ?? {};
  const { slugFromPath, chapFromPathN } = deriveFromPath(path);

  const fmSlug   = String(fm.slug ?? slugFromPath).trim();
  if (fmSlug !== wantSlug) continue;

  // prefer fm values, fall back to path-derived values
  const chapN  = Number.isFinite(Number(fm.chapter)) ? Number(fm.chapter) : chapFromPathN;
  const title  = fm.title || (Number.isFinite(chapN) ? `الفصل ${chapN}` : `الفصل`);

  if (!novelTitle) novelTitle = fm.novel || fmSlug;
  cover       = fm.cover || cover;
  description = fm.description || description;

  rows.push({
    chapter: chapN,
    title,
    url: `/novels/${wantSlug}/${String(chapN)}`,
    publishedAt: fm.publishedAt
  });
}

rows.sort((a,b)=> a.chapter - b.chapter);
const notFound = rows.length === 0;
const pageTitle = notFound ? "غير موجود" : `فصول ${novelTitle}`;
---

<Base title={pageTitle} description={description}>
  {notFound ? (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <h1 style="margin:0 0 6px">غير موجود</h1>
      <p class="muted">لا توجد فصول للرواية ذات المعرّف <code>{String(slug)}</code>.</p>
      <p><a href="/novels">العودة إلى كل الروايات</a></p>
    </section>
  ) : (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <div style="display:flex;gap:14px;align-items:center;margin-bottom:10px">
        <img src={cover} alt={novelTitle} style="width:88px;height:88px;object-fit:cover;border-radius:12px;border:1px solid var(--stroke)" />
        <div>
          <h1 style="margin:0 0 6px">{novelTitle}</h1>
          {description && <p class="muted" style="margin:0">{description}</p>}
        </div>
      </div>

      <ol style="margin:0;padding-inline-start:18px;display:grid;gap:6px">
        {rows.map(r => (
          <li>
            <a href={r.url}>الفصل {r.chapter}: {r.title}</a>
            {r.publishedAt && <span class="muted" style="margin-inline-start:8px">— {r.publishedAt}</span>}
          </li>
        ))}
      </ol>
    </section>
  )}
</Base>
