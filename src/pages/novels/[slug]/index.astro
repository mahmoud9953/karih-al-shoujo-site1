---
import Base from "@/layouts/Base.astro";

const { slug = "" } = Astro.params;
const wantSlug = String(slug).trim();

const files = import.meta.glob("/src/content/novels/**/*.md", { eager: true }) as Record<string, any>;

type Row = { chapterN:number; chapterS:string; title:string; url:string; publishedAt?:string };

const rows: Row[] = [];
let novelTitle = "";
let cover = "/cover3.png";
let description = "";

function deriveFromPath(path: string) {
  const parts = path.split("/");
  const slugFromPath = parts[4] || "";
  const fileName = parts[5] || "";
  
  // This regex will match the "001", "002" at the start of your filenames
  const m = fileName.match(/^(\d+)/); 
  
  const chapFromPathN = m ? Number(m[1]) : NaN;
  const chapFromPathS = m ? String(m[1]) : String(chapFromPathN);
  
  return { slugFromPath: String(slugFromPath).trim(), chapFromPathN, chapFromPathS };
}

for (const [path, mod] of Object.entries(files)) {
  const fm = (mod as any).frontmatter ?? {};
  const { slugFromPath, chapFromPathN, chapFromPathS } = deriveFromPath(path);

  const fmSlug = String(fm.slug ?? slugFromPath).trim();
  if (fmSlug !== wantSlug) continue;

  const chapN = Number.isFinite(Number(fm.chapter)) ? Number(fm.chapter) : chapFromPathN;
  
  // --- THIS IS THE FIX ---
  // We will ALWAYS use the chapter string from the filename (chapFromPathS)
  // This will be "001", "002", etc.
  const chapS = chapFromPathS; 
  // ------------------------

  const title = fm.title || (Number.isFinite(chapN) ? `الفصل ${chapS}` : `الفصل`);

  if (!novelTitle) novelTitle = fm.novel || fmSlug;
  cover = fm.cover || cover;
  description = fm.description || description;

  rows.push({
    chapterN: chapN,
    chapterS: chapS,
    title,
    // This will now create the correct URL, e.g., /novels/karih-al-shoujo/003
    url: `/novels/${wantSlug}/${chapS}`, 
    publishedAt: fm.publishedAt
  });
}

rows.sort((a,b)=> a.chapterN - b.chapterN);
const notFound = rows.length === 0;
const pageTitle = notFound ? "غير موجود" : `فصول ${novelTitle}`;
---

<Base title={pageTitle} description={description}>
  {notFound ? (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <h1 style="margin:0 0 6px">غير موجود</h1>
      <p class="muted">لا توجد فصول للرواية ذات المعرّف <code>{String(slug)}</code>.</p>
      <p class="muted">(تأكّد أن ملفات .md موجودة في <code>src/content/novels/{slug}/</code>)</p>
      <p><a href="/novels">العودة إلى كل الروايات</a></p>
    </section>
  ) : (
    <section class="card" style="margin:18px 0;padding:20px;border-radius:16px;">
      <div style="display:flex;gap:14px;align-items:center;margin-bottom:10px">
        <img src={cover} alt={novelTitle} style="width:88px;height:88px;object-fit:cover;border-radius:12px;border:1px solid var(--stroke)" />
        <div>
          <h1 style="margin:0 0 6px">{novelTitle}</h1>
          {description && <p class="muted" style="margin:0">{description}</p>}
        </div>
      </div>

      <ol style="margin:0;padding-inline-start:18px;display:grid;gap:6px">
        {rows.map(r => (
          <li>
            <a href={r.url}>الفصل {r.chapterS}: {r.title}</a>
            {r.publishedAt && <span class="muted" style="margin-inline-start:8px">— {r.publishedAt}</span>}
          </li>
        ))}
      </ol>
    </section>
  )}
</Base>